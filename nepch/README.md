# Nep-chan (ネップちゃん) 🦊

村のコンパニオンAI「ネップちゃん」のプロジェクトです。
Mastra Agent Framework (v1.0) を使用したエージェントベースのアプリケーションです。

## プロジェクト構成

このプロジェクトは、フロントエンドとバックエンドが統合されたモノレポ構造になっています。

- **Frontend**: `src/app` (Vite + React) - チャットUI、システム管理画面
- **Backend**: `src/mastra` (Mastra) - AIエージェント、ツール、APIサーバー

## 🚀 セットアップ & 実行

### 依存関係のインストール
```bash
bun install
```

### 開発サーバーの起動
フロントエンドとバックエンドを同時に起動します。
```bash
bun run dev
```
サーバーは `http://localhost:4112` で起動します。

---

## 🤖 エージェントアーキテクチャ

ネップちゃん（`nep-chan.ts`）を主軸としたエージェントシステムです。

### Nep-chan Agent (`nep-chan.ts`)
村のコンパニオンキャラクター「ネップちゃん」としての振る舞いを担当するメインエージェントです。
- **Persona**: 明るく親しみやすい17歳の女の子としての性格を持ちます。
- **長期記憶**: 会話履歴から記憶を生成・蓄積し、必要に応じてリコールします。
- **委譲**: 解析が必要なタスクや管理者権限が必要な操作は、Master Agentに委任します。

### Master Agent (`master-agent.ts`)
マスターモードを司るサブエージェントです。
- ネップちゃんからの依頼を受けて起動します。
- ツールを使用して詳細な解析やシステム操作を行います。
- **パスワード検証**: 重要な操作の前に認証を行います。

---

## 🛠️ 機能とツール

ネップちゃんは以下のツールとスキルを駆使してユーザーをサポートします。

### Core Tools (`src/mastra/tools`)
- **Knowledge Tool**: 村に関する知識（`nepch/knowledge/`）をRAGで検索・回答します。
- **News Tool**: 会話から村のニューストピックを収集・記録したり、最新の話題を提供します。
- **Search Tool**: Web検索を行い、最新の情報を提供します。
- **Verify Password**: セキュリティが必要な操作の認証を行います。

### Skills (`src/skills`)
特定のドメインに特化した能力（スキル）を持っています。
- **Village Guide**: 観光案内、交通情報案内。
- **Office Support**: 事務作業支援。
- **Counseling**: 悩み相談。

---

## 🖥️ UI機能 (Web Interface)

Webインターフェース (`src/app/App.tsx`) から以下の機能にアクセスできます。

### チャット画面
- **ストリーミング応答**: AIの回答がリアルタイムで表示されます。
- **ツール実行状況**: エージェントが裏側でどのツールを使用しているか可視化されます。

### サイドバー & システム管理
アコーディオンメニューから管理機能を利用できます。

- **システム管理 (System Management)**
    - **🧠 記憶を整理 (Debug)**: 会話ログから記憶を生成します。
    - **📚 知識埋め込み**: MarkdownファイルをベクトルDBに埋め込みます。
    - **⚙️ 環境変数確認**: 必要な環境変数が設定されているか確認します。
    - **🔍 ベクトル検索確認**: RAGの検索精度をテストします。
    - **🛠️ ツール登録確認**: Mastraツールが正しく登録されているか確認します。
    - **🧹 スレッド掃除**: 古いスレッドや空のスレッドを整理します。
    - **🗑️ DB初期化**: データベースをリセットします。

- **テストランナー (Test Runner)**
    - **🧪 テスト実行**: E2Eテストを実行します。実行回数（人数）を指定して、複数のシナリオをシミュレーションできます。

---

## 🧪 テスト (E2E)

Playwrightを使用したE2Eテストが統合されています。
`TestService` を通じて、バックエンドからブラウザテストをトリガーできます。

### テストの実行方法
1. UIのサイドバーにある「テストランナー」から実行回数を入力して「実行」ボタンを押す。
2. またはAPI経由で実行: `POST /api/test/run` (Body: `{ "count": 1 }`)

---

## 📁 ディレクトリ構造

```
nepch/
├── src/
│   ├── app/            # フロントエンド (React)
│   ├── mastra/         # バックエンド (Mastra)
│   │   ├── agents/     # エージェント定義
│   │   ├── tools/      # ツール定義
│   │   ├── services/   # ビジネスロジック (Service Layer)
│   │   └── ...
│   ├── skills/         # スキル定義 (Knowledge, Prompts)
│   └── server.ts       # エントリーポイント
├── knowledge/          # RAG用ドキュメント
├── e2etest/            # Playwrightテスト
└── ...
```
