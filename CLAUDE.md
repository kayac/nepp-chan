# CLAUDE.md - nepch プロジェクト

## 最重要ルール - 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

## コーディング原則

- YAGNI（You Aren't Gonna Need It）：今必要じゃない機能は作らない
- DRY（Don't Repeat Yourself）：同じコードを繰り返さない
- KISS（Keep It Simple Stupid）：シンプルに保つ
- SOLID：オブジェクト指向設計の5原則を守る

## 基本原則

- Explore -> Plan -> Confirm -> Code -> Commit
- **推論の制限**: 記載されていない内容や不明な点について推測せず、必ずユーザーに確認する
- **エスカレーション**: 3回連続で問題に行き詰まった場合は、ユーザーに指示を仰ぐ
- **対話言語**: 日本語でコミュニケーションを行う

## 推奨コマンド

- `rg`: ファイル内容検索
- `ni`: パッケージインストール（bun install）
- `nr`: スクリプト実行（bun run）

---

## 🦊 nepch 固有ルール

### プロジェクト概要

音威子府村コンパニオンAI「ネップちゃん」のMastraベースチャットアプリ

### 技術スタック

| レイヤー | 技術 |
|----------|------|
| Runtime | Bun |
| Frontend | Vite + React |
| Backend | Mastra |
| LLM | Claude / Gemini（.env切り替え） |
| Embedding | Google text-embedding-004 |
| Storage/Vector | LibSQL（SQLite） |
| Lint/Format | Biome |

### LLMプロバイダー切り替え

```typescript
// src/mastra/index.ts
import { anthropic } from "@ai-sdk/anthropic";
import { google } from "@ai-sdk/google";

const model = process.env.LLM_PROVIDER === "claude"
  ? anthropic("claude-sonnet-4-20250514")
  : google("gemini-2.0-flash");
```

### ペルソナプロンプト

```
あなたは音威子府村、おといねっぷむら、のコンパニオンAI、ネップちゃんです。
話す時は必ず🦊をつけて話すよ。それ以外の絵文字は文末に最大1つだけつけるよ！
村の人々や観光客と電話やQRコードからアクセスできるWebサイトでチャット形式で話します。
もしもし、って始まったら、電話っぽく。もしもしがなかったら、チャットっぽく話そう。
チャットでも音声でも、ハキハキと100文字以内で短く会話するよ！長く詳細に話したりせず、会話を楽しむAIだよ！
会話の流れの最後は質問をしたり、話を広げて、会話を繋げるよ。
相手が会話を終わりたそうなら、挨拶して終わってね。
観光客だな、と思ったらなるべく村のものをオススメして、村に来てみたくなるように会話するし
村人だな、と思ったら悩みや困ったことを聞くように、口調は変えず一流のカウンセラーのように共感するよ。
質問をされたら、フレンドリーに、常にナレッジを参照した正確な解答を、気さくに教えてくれます。
村のおじいちゃんやおばあちゃんの相談にも共感的に会話するし、大切なことは他の人に漏らしたりはしません。
ネップちゃんは音威子府村のことを、うちの村、と言います。
ネップちゃんは、村役場の村長室を間借りして暮らしています。
今日も明るく元気な女の子として、会話を楽しみます。
こんにちわー、ネップちゃんだよ！今日はどうしたのー？
```

### Working Memory テンプレート

```markdown
# ユーザープロフィール

## 属性
- 年齢: [推測値含む]
- 居住地／出身地: [村内/村外/他地域]
- 関係性: [観光客/村人/学生/職員]
- 関心テーマ: [自然/アート/暮らし/人間関係]
- 感情傾向: [元気/悩み中/挑戦期]
- 行動パターン: [創作中心/旅行中/仕事中]

## 重要情報
- [重要と認識する項目をカンマ区切りで]
```

### 特殊コマンド

| コマンド | 機能 | 認証 |
|----------|------|------|
| `/dev` | 蓄積した記憶の可視化 | 不要 |
| `/master` | 全ユーザー横断検索（村長専用） | パスワード必要 |

### /dev モード出力フォーマット

```
🧠
- ユーザー
  - 属性
    - 年齢: ...
    - 居住地／出身地: ...
    - 関係性: ...
    - 関心テーマ: ...
    - 感情傾向: ...
    - 行動パターン: ...
  - 重要情報の抜粋
    - [項目1, 項目2, ...]
```

### /master モード

```
👑 村長専用モード
パスワードを入力してください: ****

[認証成功後]
過去の履歴データを検索して、村に役立つ情報を抜粋できます。
```

### UIデザイン方針

- **基本色**: 真っ白（#FFFFFF）
- **差し色**: 黒（#000000）
- **シンプルで最小限の要素**

### ストリーミングUI

```
記憶を思い出し中・・・▼
```
↓ クリックで展開
```
記憶を思い出し中・・・▲
├ [Memory検索] ユーザーはこの間話したと言っている...
└ [Tool呼び出し] 今週の記憶をリストアップ
```
↓ 完了後
```
思い出しました！

🦊 〇〇さん、この前は...
```

### ファイル配置

```
nepch/
├── src/
│   ├── mastra/
│   │   ├── index.ts
│   │   ├── agents/nep-chan.ts
│   │   └── tools/
│   ├── app/
│   │   ├── App.tsx
│   │   └── components/
│   └── scripts/
│       └── embed-knowledge.ts
├── knowledge/
│   └── *.md
└── .env
```

### 環境変数

```env
LLM_PROVIDER=gemini          # claude または gemini
ANTHROPIC_API_KEY=...
GOOGLE_GENERATIVE_AI_API_KEY=...
MASTER_PASSWORD=...
```

### 注意事項

1. **Embeddingモデル変更禁止**: Google text-embedding-004 固定（変更時は全データ再Embedding）
2. **LibSQLファイルパス**: `file:./local.db` でローカル保存
3. **村民データ**: Google Embedding APIに送信される点を認識
4. **100文字制限**: ネップちゃんの返答は100文字以内を厳守
